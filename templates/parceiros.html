{% extends 'base.html' %}

{% block title %}
<title>Parceiros</title>
{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4">Parceiros</h2>
   
  {# ──────────────────────────────────────────────── #}
  {# FORMULÁRIO DE CADASTRO                         #}
  {# ──────────────────────────────────────────────── #}
  <form method="POST">
    <div class="row mb-3">
      <div class="col">
        <label class="form-label">Nome:</label>
        <input type="text" name="nome" class="form-control" required />
      </div>
      <div class="col">
        <label class="form-label">Telefone:</label>
        <input type="text" name="telefone" class="form-control" />
      </div>
    </div>

    <div class="row mb-3">
      <div class="col">
        <label class="form-label">CEP:</label>
        <input type="text" name="cep" id="cep" class="form-control" />
      </div>
      <div class="col">
        <label class="form-label">Rua:</label>
        <input type="text" name="rua" id="rua" class="form-control" />
      </div>
      <div class="col">
        <label class="form-label">Número:</label>
        <input type="text" name="numero" class="form-control" />
      </div>
    </div>

    <div class="row mb-3">
      <div class="col">
        <label class="form-label">Complemento:</label>
        <input type="text" name="complemento" class="form-control" />
      </div>
      <div class="col">
        <label class="form-label">Bairro:</label>
        <input type="text" name="bairro" id="bairro" class="form-control" />
      </div>
    </div>

    <div class="row mb-3">
      <div class="col">
        <label class="form-label">UF:</label>
        <select name="uf" id="uf" class="form-control">
          <option value="">Selecione</option>
          {% for estado in estados %}
            <option value="{{ estado.sigla }}">{{ estado.sigla }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col">
        <label class="form-label">Cidade:</label>
        <select name="cidade" id="cidade" class="form-control">
          <option value="">Selecione</option>
        </select>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col">
        <label class="form-label">CPF:</label>
        <input type="text" class="form-control" name="cpf" id="cpf" placeholder="Digite o CPF">
      </div>
       <div id="cpf-error" class="text-danger mt-1" style="display: none; font-size: 0.9em;">
        CPF inválido. Por favor, verifique.
      </div>
        <div class="col">
        <label class="form-label">PIX:</label>
        <input type="text" name="pix" class="form-control" />
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Empresas Atendidas:</label>
      <select class="form-control" name="empresas" multiple>
        {% for empresa in empresas %}
          <option value="{{ empresa.id }}">{{ empresa.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <button type="submit" class="btn btn-primary">Salvar</button>
  </form>

  <hr class="my-4" />

  <!----------Filtros---------->

<form method="GET" class="mb-3">
  <div class="row g-2 align-items-end">

    <!-- Nome -->
    <div class="col-md-3">
      <input type="text" name="f_nome" class="form-control" placeholder="Nome" value="{{ request.args.f_nome or '' }}">
    </div>

    <!-- UF -->
    <div class="col-md-1">
      <select name="f_uf" class="form-control">
        <option value="">UF</option>
        {% for estado in estados %}
          <option value="{{ estado.sigla }}" {% if request.args.f_uf == estado.sigla %}selected{% endif %}>{{ estado.sigla }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Cidade -->
    <div class="col-md-2">
      <input type="text" name="f_cidade" class="form-control" placeholder="Cidade" value="{{ request.args.f_cidade or '' }}">
    </div>

    <!-- Empresa Atendida -->
    <div class="col-md-3">
      <select name="f_empresa" class="form-control">
        <option value="">Empresa Atendida</option>
        {% for emp in empresas %}
          <option value="{{ emp.nome }}" {% if request.args.f_empresa == emp.nome %}selected{% endif %}>{{ emp.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Botões -->
    <div class="col-auto d-flex gap-2">
      <button type="submit" class="btn btn-outline-primary" title="Filtrar">
        <i class="fas fa-filter"></i>
      </button>
      <a href="{{ url_for('parceiros') }}" class="btn btn-outline-secondary" title="Limpar filtros">
        <i class="fas fa-broom"></i>
      </a>
      <a href="{{ url_for('exportar_parceiros_csv', **request.args) }}" class="btn btn-outline-success" title="Exportar CSV">
        <i class="fas fa-file-csv"></i>
      </a>
    </div>

  </div>
</form>


  {# ──────────────────────────────────────────────── #}
  {# LISTAGEM DOS PARCEIROS                         #}
  {# ──────────────────────────────────────────────── #}
  <h4 class="mb-3">Parceiros Cadastrados</h4>
  <table class="table table-bordered table-sm">
    <thead class="table-light">
      <tr>
        <th>Nome</th>
        <th>Telefone</th>
        <th>Cidade</th>
        <th>UF</th>
        <th>Empresas Atendidas</th>
        <th>Ações</th> 
        
      </tr>
    </thead>
    <tbody>
      {% for p in parceiros %}
        <tr>
          <td>{{ p.nome }}</td>
          <td>{{ p.telefone or '—' }}</td>
          <td>{{ p.cidade or '—' }}</td>
          <td>{{ p.uf or '—' }}</td>
          <td>
            {% if p.empresas %}
              {% for emp in p.empresas %}
                <div>{{ emp.nome }}</div>
              {% endfor %}
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
          <td>
              <div class="d-flex flex-row" style="gap: 4px;">
                  <form action="{{ url_for('editar_parceiro', id=p.id) }}" method="GET">
                    <button type="submit" class="btn btn-sm btn-outline-primary" title="Editar">
                        <i class="fas fa-pencil-alt"></i>
                </button>
            </form>
                  <form action="{{ url_for('delete_parceiro', id=p.id) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir este parceiro?');">
                     <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir">
                         <i class="fas fa-trash"></i>
                </button>
            </form>
        </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


<script>
document.getElementById("cep").addEventListener("blur", function () {
    const cep = this.value.replace(/\D/g, "");
    if (cep.length !== 8) return;

    fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => response.json())
        .then(data => {
            if (data.erro) {
                alert("CEP não encontrado.");
                return;
            }

            document.getElementById("rua").value = data.logradouro || "";
            document.getElementById("bairro").value = data.bairro || "";
            document.getElementById("uf").value = data.uf || "";

            // Atualiza os municípios (aguarda o endpoint /municipios/UF)
            fetch(`/municipios/${data.uf}`)
                .then(res => res.json())
                .then(municipios => {
                    const cidadeSelect = document.getElementById("cidade");
                    cidadeSelect.innerHTML = ""; // limpa antes

                    municipios.forEach(m => {
                        const opt = document.createElement("option");
                        opt.value = m;
                        opt.text = m;
                        if (m === data.localidade) opt.selected = true;
                        cidadeSelect.appendChild(opt);
                    });
                });
        })
        .catch(err => {
            console.error("Erro ao buscar CEP:", err);
        });
});
</script>


<!-- Campo hidden para restaurar cidade -->
<input type="hidden" id="cidade-selecionada" value="{{ request.form.get('cidade') or request.args.get('cidade', '') }}">

<!--------UF-cidade-dinamica-------->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const ufSelect = document.querySelector('select[name="uf"]');
    const cidadeSelect = document.querySelector('select[name="cidade"]');

    if (ufSelect && cidadeSelect) {
      ufSelect.addEventListener("change", function () {
        const uf = this.value;
        fetch(`/get_municipios/${uf}`)
          .then(response => response.json())
          .then(data => {
            cidadeSelect.innerHTML = '';
            data.forEach(cidade => {
              const option = document.createElement("option");
              option.value = cidade;
              option.text = cidade;
              cidadeSelect.appendChild(option);
            });
          });
      });
    }
  });
</script>


<!--validacao cpf-->

<script>
  function validarCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g, '');
    if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;

    let soma = 0;
    for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
    let resto = 11 - (soma % 11);
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.charAt(9))) return false;

    soma = 0;
    for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
    resto = 11 - (soma % 11);
    if (resto === 10 || resto === 11) resto = 0;

    return resto === parseInt(cpf.charAt(10));
  }

  const cpfInput = document.getElementById('cpf');
  const errorDiv = document.createElement('div');
  errorDiv.id = 'cpf-error';
  errorDiv.className = 'text-danger mt-1';
  errorDiv.style.display = 'none';
  errorDiv.style.fontSize = '0.9em';
  errorDiv.textContent = 'CPF inválido. Por favor, verifique.';
  cpfInput.parentNode.appendChild(errorDiv);

  cpfInput.addEventListener('input', function () {
    let v = this.value.replace(/\D/g, '');
    if (v.length > 11) v = v.slice(0, 11);
    v = v.replace(/(\d{3})(\d)/, '$1.$2');
    v = v.replace(/(\d{3})(\d)/, '$1.$2');
    v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    this.value = v;
  });

  cpfInput.addEventListener('blur', function () {
    if (!validarCPF(this.value)) {
      this.classList.add("is-invalid");
      errorDiv.style.display = 'block';
    } else {
      this.classList.remove("is-invalid");
      errorDiv.style.display = 'none';
    }
  });
</script>



{% endblock %}
